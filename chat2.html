<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T9 OS Chat</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{height:100vh;display:flex;background:linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);color:#e8eaf6;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;overflow:hidden}
    .sidebar{width:280px;background:rgba(15,20,40,0.95);backdrop-filter:blur(10px);border-right:1px solid rgba(100,150,255,0.1);padding:20px;display:flex;flex-direction:column;gap:10px;overflow:auto}
    .sidebar::-webkit-scrollbar{width:6px}
    .sidebar::-webkit-scrollbar-track{background:transparent}
    .sidebar::-webkit-scrollbar-thumb{background:rgba(100,150,255,0.3);border-radius:3px}
    .section-title{color:#6b9fff;font-size:.7rem;margin-top:12px;margin-bottom:4px;text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
    .sidebar-item{padding:12px 14px;background:rgba(30,40,70,0.6);border-radius:10px;cursor:pointer;transition:all 0.2s ease;border:1px solid transparent;font-size:.95rem}
    .sidebar-item:hover{background:rgba(50,70,120,0.7);border-color:rgba(100,150,255,0.2);transform:translateX(2px)}
    .sidebar-item.active{background:linear-gradient(135deg, #4e8cff 0%, #3a6fd9 100%);border-color:rgba(100,150,255,0.3);box-shadow:0 2px 8px rgba(78,140,255,0.3)}
    .chat-area{flex:1;display:flex;flex-direction:column;background:rgba(10,15,30,0.5)}
    .chat-header{padding:18px 24px;background:rgba(15,25,50,0.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(100,150,255,0.15);font-size:1.15rem;color:#a8c5ff;font-weight:600;letter-spacing:0.3px}
    .messages{flex:1;overflow:auto;padding:24px;display:flex;flex-direction:column;gap:14px}
    .messages::-webkit-scrollbar{width:8px}
    .messages::-webkit-scrollbar-track{background:transparent}
    .messages::-webkit-scrollbar-thumb{background:rgba(100,150,255,0.3);border-radius:4px}
    .msg{max-width:65%;animation:slideIn 0.2s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .msg.own{align-self:flex-end}
    .msg-name{font-size:.75rem;color:#7ea8ff;margin-bottom:5px;font-weight:500}
    .msg-bubble{background:rgba(30,45,80,0.9);padding:12px 16px;border-radius:12px;color:#e8eaf6;box-shadow:0 2px 6px rgba(0,0,0,0.2);border:1px solid rgba(100,150,255,0.1);line-height:1.5}
    .msg.own .msg-bubble{background:linear-gradient(135deg, #4e8cff 0%, #5a98ff 100%);color:#fff;border-color:rgba(255,255,255,0.1)}
    .input-bar{padding:16px 24px;background:rgba(15,25,50,0.9);backdrop-filter:blur(10px);border-top:1px solid rgba(100,150,255,0.15);display:flex;gap:12px}
    .input-bar input{flex:1;padding:14px 18px;border-radius:24px;background:rgba(30,40,70,0.8);border:1px solid rgba(100,150,255,0.2);color:#e8eaf6;font-size:.95rem;transition:all 0.2s ease}
    .input-bar input:focus{outline:none;border-color:rgba(100,150,255,0.5);background:rgba(30,40,70,1)}
    .input-bar input::placeholder{color:rgba(200,210,255,0.4)}
    .input-bar button{padding:14px 24px;background:linear-gradient(135deg, #4e8cff 0%, #3a6fd9 100%);border:none;border-radius:24px;font-weight:600;color:#fff;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 6px rgba(78,140,255,0.3)}
    .input-bar button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(78,140,255,0.4)}
    .input-bar button:active{transform:translateY(0)}
    .small{font-size:.85rem;color:#8fa8d4;line-height:1.4}
    .hidden{display:none!important}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn 0.3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{background:linear-gradient(135deg, rgba(15,25,50,0.98) 0%, rgba(20,30,60,0.98) 100%);border:1px solid rgba(100,150,255,0.3);border-radius:16px;padding:32px;min-width:360px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:modalSlide 0.3s ease}
    @keyframes modalSlide{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .modal h2{color:#a8c5ff;margin-bottom:20px;text-align:center;font-size:1.4rem;font-weight:600}
    .modal input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid rgba(100,150,255,0.3);background:rgba(30,40,70,0.8);color:#e8eaf6;margin-bottom:18px;font-size:.95rem;transition:all 0.2s ease}
    .modal input:focus{outline:none;border-color:rgba(100,150,255,0.6);background:rgba(30,40,70,1)}
    .modal input::placeholder{color:rgba(200,210,255,0.4)}
    .modal button{width:100%;padding:14px;background:linear-gradient(135deg, #4e8cff 0%, #3a6fd9 100%);border:none;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;font-size:1rem;transition:all 0.2s ease;box-shadow:0 4px 12px rgba(78,140,255,0.3)}
    .modal button:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(78,140,255,0.4)}
    .modal button:active{transform:translateY(0)}
    .room-input{width:100%;padding:10px 14px;margin-top:10px;border-radius:8px;border:1px solid rgba(100,150,255,0.2);background:rgba(20,30,55,0.8);color:#e8eaf6;font-size:.9rem;transition:all 0.2s ease}
    .room-input:focus{outline:none;border-color:rgba(100,150,255,0.5);background:rgba(20,30,55,1)}
    .room-input::placeholder{color:rgba(200,210,255,0.4)}
    .room-btn{width:100%;margin-top:10px;padding:10px;border-radius:8px;background:linear-gradient(135deg, #4e8cff 0%, #3a6fd9 100%);border:none;color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s ease}
    .room-btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(78,140,255,0.3)}
  </style>
</head>
<body>
  <div id="nameModal" class="modal-overlay">
    <div class="modal">
      <h2>Welcome to T9 OS Chat</h2>
      <input id="nameInput" placeholder="Enter your display name" maxlength="32" autocomplete="off" />
      <button id="nameSubmit">Join Chat</button>
    </div>
  </div>

  <div class="sidebar">
    <div class="section-title">Main</div>
    <div id="publicRoomBtn" class="sidebar-item active">üåç Public</div>

    <div class="section-title">Rooms</div>
    <div id="roomsList"></div>

    <div class="section-title">Actions</div>
    <div id="createBtn" class="sidebar-item">‚ûï Create Room</div>
    <div id="joinBtn" class="sidebar-item">üîç Join Room</div>

    <div id="createBox" class="hidden">
      <input id="createInput" class="room-input" placeholder="Room name" />
      <button id="doCreate" class="room-btn">Create & Join</button>
    </div>

    <div id="joinBox" class="hidden">
      <input id="joinInput" class="room-input" placeholder="Enter room name to join" />
      <button id="doJoin" class="room-btn">Join</button>
      <div class="small" style="margin-top:10px">If room doesn't exist, joining will create it for you but only you will see it until others join.</div>
    </div>
  </div>

  <div class="chat-area">
    <div class="chat-header" id="roomTitle">Public Chat</div>
    <div id="messages" class="messages"><div style="text-align:center;color:#7ea8ff;opacity:0.7">Welcome to Public Chat</div></div>

    <div class="input-bar">
      <input id="msgInput" placeholder="Type a message‚Ä¶" autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, off } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD74Fi2RKsvv1sXTAEIiTYrRKCv22MRhh8",
      authDomain: "t9oschat.firebaseapp.com",
      databaseURL: "https://t9oschat-default-rtdb.firebaseio.com",
      projectId: "t9oschat",
      storageBucket: "t9oschat.firebasestorage.app",
      messagingSenderId: "930534704832",
      appId: "1:930534704832:web:c154890c3b5f36736f8f25",
      measurementId: "G-STPKYT658F"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const publicRoomBtn = document.getElementById('publicRoomBtn');
    const roomsList = document.getElementById('roomsList');
    const createBtn = document.getElementById('createBtn');
    const joinBtn = document.getElementById('joinBtn');
    const createBox = document.getElementById('createBox');
    const joinBox = document.getElementById('joinBox');
    const createInput = document.getElementById('createInput');
    const joinInput = document.getElementById('joinInput');
    const doCreate = document.getElementById('doCreate');
    const doJoin = document.getElementById('doJoin');
    const roomTitle = document.getElementById('roomTitle');
    const nameModal = document.getElementById('nameModal');
    const nameInput = document.getElementById('nameInput');
    const nameSubmit = document.getElementById('nameSubmit');

    let username = "Anonymous";
    let currentRoom = "public";
    let myRooms = [];
    let activeChildCallback = null;
    let activeRefPath = null;

    function sanitizeRoom(name){
      return name.trim().toLowerCase();
    }

    function clearMessages(){
      messagesEl.innerHTML = '';
    }

    function appendMessage(payload){
      const div = document.createElement('div');
      div.className = 'msg' + ((payload.name||'').toLowerCase() === username.toLowerCase() ? ' own' : '');
      div.innerHTML = `<div class="msg-name">${escapeHtml(payload.name||'Anon')}</div><div class="msg-bubble">${escapeHtml(payload.text)}</div>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(s){
      return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    function detachActiveListener(){
      if (activeChildCallback && activeRefPath){
        try {
          off(ref(db, activeRefPath), 'child_added', activeChildCallback);
        } catch(e){}
        activeChildCallback = null;
        activeRefPath = null;
      }
    }

    function attachListenerForRoom(room){
      detachActiveListener();
      clearMessages();

      const path = "messages/" + room;
      const r = ref(db, path);

      const cb = (snap) => {
        const m = snap.val();
        if (!m) return;
        appendMessage(m);
      };

      onChildAdded(r, cb);
      activeChildCallback = cb;
      activeRefPath = path;
    }

    function setActiveSidebarRoomEl(room){
      document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
      if (room === 'public'){
        publicRoomBtn.classList.add('active');
      } else {
        const children = Array.from(roomsList.children);
        const found = children.find(c => c.dataset && c.dataset.room === room);
        if (found) found.classList.add('active');
      }
    }

    function addRoomToSidebar(room){
      if (myRooms.includes(room)) return;
      myRooms.push(room);

      const div = document.createElement('div');
      div.className = 'sidebar-item';
      div.textContent = 'üü£ ' + room;
      div.dataset.room = room;
      div.onclick = () => {
        joinRoomByName(room);
      };
      roomsList.appendChild(div);
    }

    function joinRoomByName(roomRaw){
      const room = sanitizeRoom(roomRaw);
      if (!room) return;
      currentRoom = room;
      roomTitle.innerText = room + " Room";
      setActiveSidebarRoomEl(room);
      addRoomToSidebar(room);
      attachListenerForRoom(room);
      createBox.classList.add('hidden');
      joinBox.classList.add('hidden');
    }

    function joinPublic(){
      currentRoom = 'public';
      roomTitle.innerText = 'Public Chat';
      setActiveSidebarRoomEl('public');
      attachListenerForRoom('public');
      createBox.classList.add('hidden');
      joinBox.classList.add('hidden');
    }

    let sendDebounce = false;
    function sendMessage(){
      const txt = msgInput.value.trim();
      if (!txt) return;
      if (sendDebounce) return;
      sendDebounce = true;
      sendBtn.disabled = true;

      push(ref(db, "messages/" + currentRoom), {
        name: username,
        text: txt,
        timestamp: Date.now()
      }).catch(err=>{
        console.error("send error", err);
      }).finally(()=>{
        setTimeout(()=>{
          sendDebounce = false;
          sendBtn.disabled = false;
        }, 350);
      });

      msgInput.value = '';
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e)=> { if (e.key === 'Enter') sendMessage(); });

    publicRoomBtn.addEventListener('click', joinPublic);

    createBtn.addEventListener('click', ()=>{
      createBox.classList.toggle('hidden');
      joinBox.classList.add('hidden');
      createInput.focus();
    });
    
    joinBtn.addEventListener('click', ()=>{
      joinBox.classList.toggle('hidden');
      createBox.classList.add('hidden');
      joinInput.focus();
    });

    doCreate.addEventListener('click', ()=>{
      const r = sanitizeRoom(createInput.value);
      if (!r) return alert('Enter a room name');
      joinRoomByName(r);
      createInput.value = '';
    });

    doJoin.addEventListener('click', ()=>{
      const r = sanitizeRoom(joinInput.value);
      if (!r) return alert('Enter a room name');
      joinRoomByName(r);
      joinInput.value = '';
    });

    function handleNameSubmit(e){
      if(e) e.preventDefault();
      const name = nameInput.value.trim();
      if (!name) {
        alert('Please enter a display name');
        return;
      }
      username = name.substring(0, 32);
      nameModal.classList.add('hidden');
      joinPublic();
    }

    nameSubmit.addEventListener('click', handleNameSubmit);
    
    nameInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') {
        e.preventDefault();
        handleNameSubmit(e);
      }
    });

    setTimeout(() => nameInput.focus(), 100);
  </script>
</body>
</html>